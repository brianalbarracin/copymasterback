===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\TuUnidadApplication.java =====
package co.edu.sena.tu_unidad;

import jakarta.annotation.PostConstruct;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.WebApplicationType;
import org.springframework.boot.builder.SpringApplicationBuilder;
import java.util.TimeZone;

@SpringBootApplication
public class TuUnidadApplication {

    public static void main(String[] args) {
        new SpringApplicationBuilder(TuUnidadApplication.class)
                .web(WebApplicationType.SERVLET)
                .run(args);
    }

    @PostConstruct
    public void init() {
        TimeZone.setDefault(TimeZone.getTimeZone("UTC-5"));
    }
}


// 

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\config\SecurityConfig.java =====
package co.edu.sena.tu_unidad.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.web.cors.CorsConfiguration;

import java.util.List;

@Configuration
public class SecurityConfig {

    @Bean
    public AuthenticationManager authenticationManager(AuthenticationConfiguration configuration) throws Exception {
        return configuration.getAuthenticationManager();
    }

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .csrf(csrf -> csrf.disable())
            .cors(cors -> cors.configurationSource(request -> {
                CorsConfiguration config = new CorsConfiguration();
                config.setAllowedOrigins(List.of("http://localhost:3000", "https://irrigex-front.onrender.com", "https://copymasterfront.onrender.com"));
                config.setAllowedMethods(List.of("GET","POST","PUT","DELETE","OPTIONS"));
                config.setAllowedHeaders(List.of("*"));
                config.setAllowCredentials(true);
                return config;
            }))
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/auth/**","/public/**",
                        "/technicians/**",
                        "/mach/service-visits/**",
                        "/machine-movements/**",
                        "/meter-readings/**",
                        "/parts/**",
                        "/visit-parts/**",
                        "/locations/**",
                        "/service-requests/**",
                        "/reading-toner/**",
                        "/machines/**",
                        "/root-causes/**",
                        "/visits/**",
                        "/customers/**").permitAll()
                .anyRequest().authenticated()
            )
            .httpBasic();
        return http.build();
    }
}


// 

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\controller\AuthController.java =====
package co.edu.sena.tu_unidad.controller;

import co.edu.sena.tu_unidad.dto.LoginRequestDto;
import co.edu.sena.tu_unidad.dto.LoginResponseDto;
import co.edu.sena.tu_unidad.dto.ServerResponseDto;
import co.edu.sena.tu_unidad.service.AuthService;
import co.edu.sena.tu_unidad.service.UserService;
import co.edu.sena.tu_unidad.entity.UserEntity;
import co.edu.sena.tu_unidad.repository.UserRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.*;
import co.edu.sena.tu_unidad.dto.UserDto;

@RestController
@RequestMapping("/auth")
public class AuthController {

    @Autowired
    private AuthService authService;
    @Autowired
    private UserService userService;
    @Autowired
    private UserRepository userRepository;

    @PostMapping("/login")
    public ServerResponseDto login(@RequestBody LoginRequestDto request) {
        try {
            LoginResponseDto resp = authService.login(request);
            return ServerResponseDto.builder()
                    .status(HttpStatus.OK.value())
                    .message("Login exitoso")
                    .data(resp)
                    .build();
        } catch (Exception e) {
            return ServerResponseDto.builder()
                    .status(HttpStatus.UNAUTHORIZED.value())
                    .message("Credenciales inv√°lidas: " + e.getMessage())
                    .data(null)
                    .build();
        }
    }

    @PostMapping("/register")
    public ServerResponseDto register(@RequestBody UserEntity user) {
        if (userRepository.existsByUsername(user.getUsername())) {
            return ServerResponseDto.builder()
                    .status(HttpStatus.BAD_REQUEST.value())
                    .message("El nombre de usuario ya existe")
                    .data(null)
                    .build();
        }
        UserDto dto = UserDto.builder()
                .username(user.getUsername())
                .email(user.getEmail())
                .fullName(user.getFullName())
                .role(user.getRole())
                .phone(user.getPhone())
                .build();
        UserDto created = userService.register(dto);
        return ServerResponseDto.builder()
                .status(HttpStatus.CREATED.value())
                .message("Usuario registrado")
                .data(created)
                .build();
    }
}


// 

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\controller\CustomerController.java =====
package co.edu.sena.tu_unidad.controller;

import co.edu.sena.tu_unidad.dto.CustomerDto;
import co.edu.sena.tu_unidad.entity.ServiceRequestEntity;
import co.edu.sena.tu_unidad.service.CustomerService;
import co.edu.sena.tu_unidad.service.ServiceRequestService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

@RestController
@RequestMapping("/customers")
@CrossOrigin(origins = "*") // habilita llamadas desde tu front
public class CustomerController {

    @Autowired
    private CustomerService customerService;

    @Autowired
    private ServiceRequestService requestService;

    private ResponseEntity<Map<String, Object>> buildResponse(int status, String message, Object data) {
        Map<String, Object> resp = new HashMap<>();
        resp.put("status", status);
        resp.put("message", message);
        resp.put("data", data);
        return ResponseEntity.status(status).body(resp);
    }

    // üîπ Listar todos los clientes
    @GetMapping
    public ResponseEntity<Map<String, Object>> getAll() {
        List<CustomerDto> customers = customerService.getAllCustomers();
        return buildResponse(200, "Clientes obtenidos", customers);
    }

    // üîπ Obtener un cliente por id
    @GetMapping("/{id}")
    public ResponseEntity<Map<String, Object>> getById(@PathVariable Long id) {
        CustomerDto c = customerService.getCustomerById(id);
        if (c == null) {
            return buildResponse(404, "Cliente no encontrado", null);
        }
        return buildResponse(200, "Cliente obtenido", c);
    }

    // üîπ Crear cliente
    @PostMapping
    public ResponseEntity<Map<String, Object>> create(@RequestBody CustomerDto dto) {
        CustomerDto c = customerService.createCustomer(dto);
        return buildResponse(201, "Cliente creado", c);
    }

    // üîπ Actualizar cliente
    @PutMapping("/{id}")
    public ResponseEntity<Map<String, Object>> update(@PathVariable Long id, @RequestBody CustomerDto dto) {
        CustomerDto c = customerService.updateCustomer(id, dto);
        if (c == null) {
            return buildResponse(404, "Cliente no encontrado", null);
        }
        return buildResponse(200, "Cliente actualizado", c);
    }

    // üîπ Eliminar cliente
    @DeleteMapping("/{id}")
    public ResponseEntity<Map<String, Object>> delete(@PathVariable Long id) {
        boolean ok = customerService.deleteCustomer(id);
        if (!ok) {
            return buildResponse(404, "Cliente no encontrado", null);
        }
        return buildResponse(200, "Cliente eliminado", true);
    }

    // üîπ Obtener solicitudes asociadas a un cliente
    @GetMapping("/{id}/requests")
    public ResponseEntity<Map<String, Object>> getRequests(@PathVariable Long id) {
        List<ServiceRequestEntity> requests = requestService.getRequestsByCustomer(id);
        return buildResponse(200, "Solicitudes del cliente obtenidas", requests);
    }
}


===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\controller\LocationController.java =====
package co.edu.sena.tu_unidad.controller;

import co.edu.sena.tu_unidad.entity.LocationEntity;
import co.edu.sena.tu_unidad.repository.LocationRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/locations")
@RequiredArgsConstructor
public class LocationController {
    private final LocationRepository repo;

    @PostMapping
    public LocationEntity create(@RequestBody LocationEntity location) {
        return repo.save(location);
    }

    @GetMapping
    public List<LocationEntity> getAll() {
        return repo.findAll();
    }
}


===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\controller\MachineController.java =====
package co.edu.sena.tu_unidad.controller;

import co.edu.sena.tu_unidad.dto.MachineDto;
import co.edu.sena.tu_unidad.dto.ServerResponseDto;
import co.edu.sena.tu_unidad.service.MachineService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/machines")
public class MachineController {

    @Autowired
    private MachineService machineService;

    @GetMapping
    public ServerResponseDto getAll() {
        List<MachineDto> list = machineService.getAllMachines();
        return ServerResponseDto.builder()
                .status(HttpStatus.OK.value())
                .message("M√°quinas obtenidas")
                .data(list)
                .build();
    }

    @GetMapping("/{id}")
    public ServerResponseDto getById(@PathVariable Long id) {
        MachineDto m = machineService.getMachineById(id);
        return ServerResponseDto.builder()
                .status(m != null ? HttpStatus.OK.value() : HttpStatus.NOT_FOUND.value())
                .message(m != null ? "M√°quina encontrada" : "No encontrada")
                .data(m)
                .build();
    }

    @GetMapping("/search")
    public ServerResponseDto searchByModel(@RequestParam String model) {
        return ServerResponseDto.builder()
                .status(HttpStatus.OK.value())
                .message("Resultados")
                .data(machineService.searchByModel(model))
                .build();
    }

    @PostMapping
    public ServerResponseDto create(@RequestBody MachineDto dto) {
        MachineDto created = machineService.createMachine(dto);
        return ServerResponseDto.builder()
                .status(HttpStatus.CREATED.value())
                .message("M√°quina creada")
                .data(created)
                .build();
    }

    @PutMapping("/{id}")
    public ServerResponseDto update(@PathVariable Long id, @RequestBody MachineDto dto) {
        MachineDto updated = machineService.updateMachine(id, dto);
        return ServerResponseDto.builder()
                .status(updated != null ? HttpStatus.OK.value() : HttpStatus.NOT_FOUND.value())
                .message(updated != null ? "M√°quina actualizada" : "No encontrada")
                .data(updated)
                .build();
    }

    @DeleteMapping("/{id}")
    public ServerResponseDto delete(@PathVariable Long id) {
        machineService.deleteMachine(id);
        return ServerResponseDto.builder()
                .status(HttpStatus.OK.value())
                .message("M√°quina eliminada")
                .data(null)
                .build();
    }
}


// 

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\controller\MachineMovementController.java =====
package co.edu.sena.tu_unidad.controller;

import co.edu.sena.tu_unidad.dto.ServerResponseDto;
import co.edu.sena.tu_unidad.entity.MachineMovementEntity;
import co.edu.sena.tu_unidad.entity.MachineEntity;
import co.edu.sena.tu_unidad.repository.MachineRepository;
import co.edu.sena.tu_unidad.domain.enums.MovementType;
import co.edu.sena.tu_unidad.repository.MachineMovementRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.*;

import java.time.OffsetDateTime;

@RestController
@RequestMapping("/machine-movements")
@RequiredArgsConstructor

public class MachineMovementController {

    private final MachineMovementRepository repo;
    private final MachineRepository machineRepo;

    @GetMapping
    public ServerResponseDto listByMachine(@RequestParam Long machineId) {
        return ServerResponseDto.builder()
                .status(200)
                .message("Movimientos obtenidos")
                .data(repo.findByMachineIdOrderByEffectiveDateDesc(machineId))
                .build();
    }

    @PostMapping
    public ServerResponseDto create(@RequestBody MachineMovementEntity move) {
        move.setEffectiveDate(OffsetDateTime.now());
        if (move.getMovementType() == null) {
            move.setMovementType(MovementType.TRASLADO); // o usa tu enum si corresponde
        }

        // Guardar movimiento
        MachineMovementEntity saved = repo.save(move);

        // Actualizar ubicaci√≥n actual en la m√°quina
        MachineEntity machine = machineRepo.findById(move.getMachineId()).orElse(null);
        if (machine != null && move.getToLocationId() != null) {
            machine.setCurrentLocationId(move.getToLocationId());
            machineRepo.save(machine);
        }

        return ServerResponseDto.builder()
                .status(201)
                .message("Movimiento creado")
                .data(saved)
                .build();
    }
}


===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\controller\MeterReadingController.java =====
package co.edu.sena.tu_unidad.controller;

import co.edu.sena.tu_unidad.dto.ServerResponseDto;
import co.edu.sena.tu_unidad.entity.MeterReadingEntity;
import co.edu.sena.tu_unidad.repository.MeterReadingRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/meter-readings")
public class MeterReadingController {

    @Autowired
    private MeterReadingRepository repo;

    @GetMapping("/machine/{machineId}")
    public ServerResponseDto readingsByMachine(@PathVariable Long machineId) {
        List<MeterReadingEntity> list = repo.findByMachineIdOrderByReadingDateDesc(machineId);
        return ServerResponseDto.builder()
                .status(HttpStatus.OK.value())
                .message("Lecturas")
                .data(list)
                .build();
    }

    @PostMapping
    public ServerResponseDto create(@RequestBody MeterReadingEntity e) {
        MeterReadingEntity saved = repo.save(e);
        return ServerResponseDto.builder()
                .status(HttpStatus.CREATED.value())
                .message("Lectura creada")
                .data(saved)
                .build();
    }
}


// 

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\controller\PartController.java =====
package co.edu.sena.tu_unidad.controller;

import co.edu.sena.tu_unidad.dto.ServerResponseDto;
import co.edu.sena.tu_unidad.entity.PartEntity;
import co.edu.sena.tu_unidad.repository.PartRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/parts")
public class PartController {

    @Autowired
    private PartRepository repo;

    @GetMapping
    public ServerResponseDto getAll() {
        List<PartEntity> parts = repo.findAll();
        return ServerResponseDto.builder()
                .status(HttpStatus.OK.value())
                .message("Repuestos")
                .data(parts)
                .build();
    }

    @PostMapping
    public ServerResponseDto create(@RequestBody PartEntity p) {
        PartEntity saved = repo.save(p);
        return ServerResponseDto.builder()
                .status(HttpStatus.CREATED.value())
                .message("Repuesto creado")
                .data(saved)
                .build();
    }
}

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\controller\ReadingTonerController.java =====
package co.edu.sena.tu_unidad.controller;
import co.edu.sena.tu_unidad.dto.ReadingTonerDto;
import co.edu.sena.tu_unidad.dto.ServerResponseDto;
import co.edu.sena.tu_unidad.service.ReadingTonerService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/reading-toner")
public class ReadingTonerController {
    @Autowired
    private ReadingTonerService readingTonerService;

    @GetMapping("/machine/{machineId}")
    public ServerResponseDto getReadingsByMachine(@PathVariable Long machineId) {
        List<ReadingTonerDto> readings = readingTonerService.getReadingsByMachine(machineId);
        return ServerResponseDto.builder()
                .status(HttpStatus.OK.value())
                .message("Lecturas de toner obtenidas")
                .data(readings)
                .build();
    }

    @PostMapping
    public ServerResponseDto createReading(@RequestBody ReadingTonerDto dto) {
        ReadingTonerDto created = readingTonerService.createReadingToner(dto);
        return ServerResponseDto.builder()
                .status(HttpStatus.CREATED.value())
                .message("Lectura de toner creada")
                .data(created)
                .build();
    }

    @GetMapping("/{id}")
    public ServerResponseDto getReadingById(@PathVariable Long id) {
        ReadingTonerDto reading = readingTonerService.getReadingTonerById(id);
        return ServerResponseDto.builder()
                .status(reading != null ? HttpStatus.OK.value() : HttpStatus.NOT_FOUND.value())
                .message(reading != null ? "Lectura encontrada" : "No encontrada")
                .data(reading)
                .build();
    }

    @PutMapping("/{id}")
    public ServerResponseDto updateReading(@PathVariable Long id, @RequestBody ReadingTonerDto dto) {
        ReadingTonerDto updated = readingTonerService.updateReadingToner(id, dto);
        return ServerResponseDto.builder()
                .status(HttpStatus.OK.value())
                .message("Lectura de toner actualizada")
                .data(updated)
                .build();
    }

    @DeleteMapping("/{id}")
    public ServerResponseDto deleteReading(@PathVariable Long id) {
        readingTonerService.deleteReadingToner(id);
        return ServerResponseDto.builder()
                .status(HttpStatus.OK.value())
                .message("Lectura de toner eliminada")
                .data(null)
                .build();
    }


}


===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\controller\RootCauseController.java =====
package co.edu.sena.tu_unidad.controller;
import co.edu.sena.tu_unidad.dto.RootCauseDto;
import co.edu.sena.tu_unidad.dto.ServerResponseDto;
import co.edu.sena.tu_unidad.service.RootCauseService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.Map;

@RestController
@RequestMapping("/root-causes")

public class RootCauseController {

    @Autowired
    private RootCauseService rootCauseService;

    @GetMapping
    public ServerResponseDto getAll() {
        List<RootCauseDto> list = rootCauseService.getAllRootCauses();
        return ServerResponseDto.builder()
                .status(HttpStatus.OK.value())
                .message("Causas ra√≠z obtenidas")
                .data(list)
                .build();
    }

    @GetMapping("/categories")
    public ServerResponseDto getCategories() {
        List<String> categories = rootCauseService.getAllCategories();
        return ServerResponseDto.builder()
                .status(HttpStatus.OK.value())
                .message("Categor√≠as obtenidas")
                .data(categories)
                .build();
    }

    @GetMapping("/by-category")
    public ServerResponseDto getByCategory(@RequestParam String category) {
        List<RootCauseDto> list = rootCauseService.getRootCausesByCategory(category);
        return ServerResponseDto.builder()
                .status(HttpStatus.OK.value())
                .message("Causas ra√≠z por categor√≠a")
                .data(list)
                .build();
    }

    @GetMapping("/grouped")
    public ServerResponseDto getGrouped() {
        Map<String, List<RootCauseDto>> grouped = rootCauseService.getRootCausesGroupedByCategory();
        return ServerResponseDto.builder()
                .status(HttpStatus.OK.value())
                .message("Causas ra√≠z agrupadas por categor√≠a")
                .data(grouped)
                .build();
    }




}


===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\controller\ServiceRequestController.java =====
package co.edu.sena.tu_unidad.controller;

import co.edu.sena.tu_unidad.dto.ServerResponseDto;
import co.edu.sena.tu_unidad.dto.ServiceRequestDto;
import co.edu.sena.tu_unidad.entity.ServiceVisitEntity;
import co.edu.sena.tu_unidad.service.ServiceRequestService;
import co.edu.sena.tu_unidad.service.ServiceVisitService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.*;
import co.edu.sena.tu_unidad.domain.enums.ServiceType;

import java.util.List;
import java.util.Collections;

@RestController
@RequestMapping("/service-requests")
public class ServiceRequestController {

    @Autowired
    private ServiceRequestService service;

    @Autowired
    private ServiceVisitService visitService;

    @GetMapping
    public ServerResponseDto getAll() {
        System.out.println("üìã GET /service-requests - Obteniendo todas las solicitudes");
        System.out.println("üìã Hora: " + new java.util.Date());

        try {
            List<ServiceRequestDto> requests = service.getAllServiceRequests();
            System.out.println("‚úÖ Solicitudes obtenidas: " + requests.size());

            if (requests.isEmpty()) {
                System.out.println("‚ö†Ô∏è No hay solicitudes en la base de datos");
                // Devuelve una lista vac√≠a en lugar de null
                return ServerResponseDto.builder()
                        .status(HttpStatus.OK.value())
                        .message("No hay solicitudes")
                        .data(Collections.emptyList())
                        .build();
            }

            System.out.println("üìã Primera solicitud ID: " + requests.get(0).getId());
            System.out.println("üìã Primera solicitud RequestNumber: " + requests.get(0).getRequestNumber());
            System.out.println("üìã Primera solicitud ServiceType: " + requests.get(0).getServiceType());

            ServerResponseDto response = ServerResponseDto.builder()
                    .status(HttpStatus.OK.value())
                    .message("Solicitudes obtenidas")
                    .data(requests)
                    .build();

            System.out.println("‚úÖ Response creado, status: " + response.getStatus());
            return response;
        } catch (Exception e) {
            System.out.println("‚ùå Error obteniendo solicitudes: " + e.getMessage());
            e.printStackTrace();
            return ServerResponseDto.builder()
                    .status(HttpStatus.INTERNAL_SERVER_ERROR.value())
                    .message("Error al obtener solicitudes: " + e.getMessage())
                    .data(null)
                    .build();
        }
    }

    @GetMapping("/pending")
    public ServerResponseDto getPending() {
        return ServerResponseDto.builder()
                .status(HttpStatus.OK.value())
                .message("Pendientes")
                .data(service.getPendingServiceRequests())
                .build();
    }


    @GetMapping("/{id}")
    public ServerResponseDto getById(@PathVariable Long id) {
        ServiceRequestDto request = service.getServiceRequestById(id);
        if (request == null) {
            return ServerResponseDto.builder()
                    .status(HttpStatus.NOT_FOUND.value())
                    .message("Solicitud no encontrada")
                    .data(null)
                    .build();
        }
        return ServerResponseDto.builder()
                .status(HttpStatus.OK.value())
                .message("Solicitud obtenida")
                .data(request)
                .build();
    }

    @GetMapping("/customer/{customerId}")
    public ServerResponseDto byCustomer(@PathVariable Long customerId) {
        return ServerResponseDto.builder()
                .status(HttpStatus.OK.value())
                .message("Solicitudes por cliente")
                .data(service.getServiceRequestsByCustomer(customerId))
                .build();
    }

    @PostMapping
    public ServerResponseDto create(@RequestBody ServiceRequestDto dto) {
        ServiceRequestDto created = service.createServiceRequest(dto);
        return ServerResponseDto.builder()
                .status(HttpStatus.CREATED.value())
                .message("Solicitud creada")
                .data(created)
                .build();
    }

    @PostMapping("/{requestId}/visit")
    public ServerResponseDto addVisit(@PathVariable Long requestId, @RequestBody ServiceVisitEntity visit) {
        // Endpoint simple que delega a serviceVisit
        return ServerResponseDto.builder()
                .status(HttpStatus.CREATED.value())
                .message("Visita agregada (usa /visits para detalle)")
                .data(null)
                .build();
    }

    @PutMapping("/{requestId}/status")
    public ServerResponseDto updateStatus(@PathVariable Long requestId, @RequestParam String status) {
        ServiceRequestDto updated = service.updateServiceRequestStatus(requestId, status);
        return ServerResponseDto.builder()
                .status(HttpStatus.OK.value())
                .message("Estado actualizado")
                .data(updated)
                .build();
    }
    @GetMapping("/machine/{machineId}")
    public ServerResponseDto byMachine(@PathVariable Long machineId) {
        return ServerResponseDto.builder()
                .status(HttpStatus.OK.value())
                .message("Solicitudes por m√°quina")
                .data(service.getServiceRequestsByMachine(machineId)) // necesitas implementarlo en ServiceRequestService
                .build();
    }

    @GetMapping("/test")
    public ServerResponseDto test() {
        System.out.println("üß™ Probando endpoint /test");

        try {
            // Crear un DTO simple para prueba
            ServiceRequestDto testDto = ServiceRequestDto.builder()
                    .id(1L)
                    .requestNumber("001ST091225")
                    .customerId(1L)
                    .machineId(1L)
                    .serviceType(ServiceType.servicio_tecnico)  // Usa tu enum
                    .status("ABIERTA")
                    .build();

            System.out.println("üß™ DTO de prueba creado: " + testDto);

            return ServerResponseDto.builder()
                    .status(HttpStatus.OK.value())
                    .message("Test exitoso")
                    .data(testDto)
                    .build();
        } catch (Exception e) {
            System.out.println("‚ùå Error en test: " + e.getMessage());
            e.printStackTrace();
            return ServerResponseDto.builder()
                    .status(HttpStatus.INTERNAL_SERVER_ERROR.value())
                    .message("Error en test: " + e.getMessage())
                    .data(null)
                    .build();
        }
    }




}


// 

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\controller\ServiceVisitController.java =====
package co.edu.sena.tu_unidad.controller;

import co.edu.sena.tu_unidad.dto.ServerResponseDto;
import co.edu.sena.tu_unidad.dto.ServiceVisitDto;
import co.edu.sena.tu_unidad.entity.ServiceVisitEntity;
import co.edu.sena.tu_unidad.service.ServiceVisitService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import java.util.List;
import org.springframework.http.HttpStatus;

@RestController
@RequestMapping("/visits")
public class ServiceVisitController {

    @Autowired
    private ServiceVisitService service;

    @PostMapping
    public ServerResponseDto create(@RequestBody ServiceVisitDto dto) {
        ServiceVisitDto created = service.createServiceVisit(dto);
        return ServerResponseDto.builder()
                .status(HttpStatus.CREATED.value())
                .message("Visita creada")
                .data(created)
                .build();
    }


    // Actualizar visita
    @PutMapping("/{id}")
    public ResponseEntity<ServerResponseDto> updateVisit(@PathVariable Long id,
                                                         @RequestBody ServiceVisitDto dto) {
        ServiceVisitDto updated = service.updateServiceVisit(id, dto);
        return ResponseEntity.ok(ServerResponseDto.builder()
                .status(HttpStatus.OK.value())
                .message("Visita actualizada")
                .data(updated)
                .build());
    }

    // Listar visitas por service_request_id
    @GetMapping("/request/{requestId}")
    public List<ServiceVisitDto> getByRequest(@PathVariable Long requestId) {
        return service.getVisitsByRequest(requestId);  // ‚úÖ correcto
    }
}


// 

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\controller\TechnicianController.java =====
package co.edu.sena.tu_unidad.controller;

import co.edu.sena.tu_unidad.dto.ServerResponseDto;
import co.edu.sena.tu_unidad.dto.TechnicianDto;
import co.edu.sena.tu_unidad.service.TechnicianService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/technicians")
public class TechnicianController {

    @Autowired
    private TechnicianService technicianService;

    @GetMapping
    public ServerResponseDto getAll() {
        List<TechnicianDto> list = technicianService.getAllTechnicians();
        return ServerResponseDto.builder()
                .status(HttpStatus.OK.value())
                .message("T√©cnicos obtenidos")
                .data(list)
                .build();
    }

    @GetMapping("/{id}")
    public ServerResponseDto getById(@PathVariable Long id) {
        TechnicianDto t = technicianService.getTechnicianById(id);
        return ServerResponseDto.builder()
                .status(t != null ? HttpStatus.OK.value() : HttpStatus.NOT_FOUND.value())
                .message(t != null ? "T√©cnico encontrado" : "No encontrado")
                .data(t)
                .build();
    }

    @PostMapping
    public ServerResponseDto create(@RequestBody TechnicianDto dto) {
        TechnicianDto created = technicianService.createTechnician(dto);
        return ServerResponseDto.builder()
                .status(HttpStatus.CREATED.value())
                .message("T√©cnico creado")
                .data(created)
                .build();
    }

    @PutMapping("/{id}")
    public ServerResponseDto update(@PathVariable Long id, @RequestBody TechnicianDto dto) {
        TechnicianDto updated = technicianService.updateTechnician(id, dto);
        return ServerResponseDto.builder()
                .status(HttpStatus.OK.value())
                .message("T√©cnico actualizado")
                .data(updated)
                .build();
    }
}


// 

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\controller\VisitPartController.java =====
package co.edu.sena.tu_unidad.controller;

import co.edu.sena.tu_unidad.dto.VisitPartDto;
import co.edu.sena.tu_unidad.service.VisitPartService;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/visit-parts")
@RequiredArgsConstructor
public class VisitPartController {

    private final VisitPartService visitPartService;

    @PostMapping
    public ResponseEntity<VisitPartDto> create(@RequestBody VisitPartDto dto) {
        return ResponseEntity.ok(visitPartService.create(dto));
    }

    @GetMapping("/visit/{visitId}")
    public ResponseEntity<List<VisitPartDto>> getByServiceVisit(@PathVariable Long visitId) {
        return ResponseEntity.ok(visitPartService.getByServiceVisit(visitId));
    }

    @DeleteMapping("/{id}")
    public ResponseEntity<Void> delete(@PathVariable Long id) {
        visitPartService.delete(id);
        return ResponseEntity.noContent().build();
    }
}


===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\domain\enums\CommChannel.java =====
package co.edu.sena.tu_unidad.domain.enums;

public enum CommChannel {
    telefono,
    whatsapp,
    email,
    portal
}


===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\domain\enums\MachineStatus.java =====
package co.edu.sena.tu_unidad.domain.enums;

public enum MachineStatus {
    BODEGA,
    INSTALADA,
    MANTENIMIENTO,
    RETIRADA
}


===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\domain\enums\MovementType.java =====
package co.edu.sena.tu_unidad.domain.enums;

public enum MovementType {
    INGRESO,
    SALIDA,
    TRASLADO,
    VENTA,
    CHATARRIZACION,
    RETORNO_ALQUILER,
    OTRO
}


===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\domain\enums\ServiceType.java =====
package co.edu.sena.tu_unidad.domain.enums;

public enum ServiceType {

    servicio_tecnico("ST"),  // Servicio T√©cnico
    lectura_contador("LC"),
    diagnostico("STD"),
    toma_contador("TC"),
    correctivo("C"),
    toner("TN"),
    remoto("R"),  // Agregado
    otro("O");  // Por defecto

    private final String codigo;

    ServiceType(String codigo) {
        this.codigo = codigo;
    }

    public String getCodigo() {
        return codigo;
    }
}


===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\dto\CustomerDto.java =====
package co.edu.sena.tu_unidad.dto;

import lombok.*;

@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class CustomerDto {
    private Long id;
    private String nit;
    private String name;
    private String contactName;
    private String phone;
    private String email;
    private String address;
    private LocationDto location;

}


===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\dto\LocationDto.java =====
package co.edu.sena.tu_unidad.dto;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class LocationDto {
    private Long id;
    private String name;
    private String address;
    private String description;
}


===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\dto\LoginRequestDto.java =====
package co.edu.sena.tu_unidad.dto;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class LoginRequestDto {
    private String username;
    private String password;
}


// 

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\dto\LoginResponseDto.java =====
package co.edu.sena.tu_unidad.dto;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class LoginResponseDto {
    private Long id;
    private String username;
    private String fullName;
    private String role;
    private String token; // opcional, queda vac√≠o si no usas JWT
}


// 

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\dto\MachineDto.java =====
package co.edu.sena.tu_unidad.dto;

import lombok.AllArgsConstructor;
import co.edu.sena.tu_unidad.domain.enums.MachineStatus;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class MachineDto {
    private Long id;
    private String companySerial;
    private String companyNumber;
    private String model;
    private String brand;
    private Integer year;
    private Long currentLocationId;
    private MachineStatus status;
    private Long currentCustomerId;
    private Long initialReading;
    private Long initialColorReading;
    private Long initialScannerReading;// lectura inicial
    private String readingNotes;
    private String notes;

}


// 

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\dto\MeterReadingDto.java =====
package co.edu.sena.tu_unidad.dto;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;
import java.time.OffsetDateTime;

@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class MeterReadingDto {

    private Long id;
    private Long machineId;
    private Long reading;
    private OffsetDateTime readingDate;
    private Long technicianId;
    private String notes;
    private Long colorReading;
    private Long scannerReading;
}


===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\dto\ReadingTonerDto.java =====
package co.edu.sena.tu_unidad.dto;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;
import java.time.OffsetDateTime;

@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor

public class ReadingTonerDto {
    private Long id;
    private Long machineId;
    private Long technicianId;
    private OffsetDateTime readingDate;
    private String notes;
    private Integer levelK;  // Black
    private Integer levelC;  // Cyan
    private Integer levelM;  // Magenta
    private Integer levelY;  // Yellow
}


===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\dto\RootCauseDto.java =====
package co.edu.sena.tu_unidad.dto;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class RootCauseDto {
    private Long id;
    private String name;
    private String category;

}


===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\dto\ServerResponseDto.java =====
package co.edu.sena.tu_unidad.dto;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class ServerResponseDto {
    private int status;
    private String message;
    private Object data;
}


// 

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\dto\ServiceRequestDto.java =====
package co.edu.sena.tu_unidad.dto;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;
import co.edu.sena.tu_unidad.domain.enums.CommChannel;
import co.edu.sena.tu_unidad.domain.enums.ServiceType;

import java.time.OffsetDateTime;

@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class ServiceRequestDto {
    private Long id;
    private String requestNumber;
    private Long customerId;
    private Long machineId;
    private String companySerial;
    private String companyNumber;
    private Long createdByUserId;
    private OffsetDateTime reportedAt;
    private CommChannel reportedChannel;
    private ServiceType serviceType;
    private String description;
    private String rootCause;
    private String status;
    private Boolean isRepeated;
    private Long repeatedOfRequestId;
    private Long assignedTechnicianId;
    private OffsetDateTime assignedAt;
    private OffsetDateTime closedAt;
    private String resolution;
    private Long rootCauseId;
}


// 

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\dto\ServiceVisitDto.java =====
package co.edu.sena.tu_unidad.dto;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.time.OffsetDateTime;
import java.util.Map;

@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class ServiceVisitDto {
    private Long id;
    private Long serviceRequestId;
    private OffsetDateTime visitDatetime;
    private Long technicianId;
    private String visitNotes;
    private Map<String, Object> partsUsed;
    private Long meterReadingBefore;
    private Long meterReadingAfter;
    private Boolean solved;
    private Boolean takeMeterReading;
    private Long reading;        // valor de la lectura
    private Long colorReading;
    private Long scannerReading;
    private String readingNotes;
    private Long machineId;
    // Mediciones de toner (nuevo)
    private Boolean takeTonerReading;
    private Integer tonerLevelK;
    private Integer tonerLevelC;
    private Integer tonerLevelM;
    private Integer tonerLevelY;
    private String tonerNotes;
    private Long tonerReadingId; // Para referencia al registro de toner

    // NUEVO: Campos para causa ra√≠z de la visita
    private Long rootCauseId;
    private String rootCauseName;
    private String rootCauseCategory;

    private OffsetDateTime startTime;
    private OffsetDateTime endTime;


}


// 

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\dto\TechnicianDto.java =====
package co.edu.sena.tu_unidad.dto;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class TechnicianDto {
    private Long id;
    private String identification;
    private String fullName;
    private String phone;
    private String email;
    private Boolean active;
}


// 

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\dto\UserDto.java =====
package co.edu.sena.tu_unidad.dto;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@AllArgsConstructor
@NoArgsConstructor
@Builder
public class UserDto {
    private Long id;
    private String username;
    private String email;
    private String fullName;
    private String role;
    private String phone;
}


// 

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\dto\VisitPartDto.java =====
package co.edu.sena.tu_unidad.dto;

import lombok.*;
import java.math.BigDecimal;

@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class VisitPartDto {
    private Long id;
    private Long serviceVisitId;
    private Long partId;
    private Integer qty;
    private String serialNumber;
    private BigDecimal cost;
    private String name;
    private String sku;
}


===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\entity\CustomerEntity.java =====
package co.edu.sena.tu_unidad.entity;

import jakarta.persistence.*;
import lombok.*;
import jakarta.persistence.OneToOne;
import jakarta.persistence.JoinColumn;

import java.time.OffsetDateTime;

@Entity
@Table(name = "customers")
@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class CustomerEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(unique = true)
    private String nit;   // puede ser null si es persona natural

    @Column(nullable = false)
    private String name;

    @Column(name = "contact_name")
    private String contactName;

    private String phone;

    private String email;

    private String address;

    @Column(name = "created_at")
    private OffsetDateTime createdAt;

    @OneToOne(cascade = CascadeType.ALL)
    @JoinColumn(name = "location_id", referencedColumnName = "id")
    private LocationEntity location;
}


// 

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\entity\LocationEntity.java =====
package co.edu.sena.tu_unidad.entity;

import jakarta.persistence.*;
import lombok.*;

@Entity
@Table(name = "locations")
@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class LocationEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(unique = true)
    private String code;

    private String name;
    private String description;
    private String address;
}


// 

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\entity\MachineEntity.java =====
package co.edu.sena.tu_unidad.entity;

import jakarta.persistence.*;
import co.edu.sena.tu_unidad.domain.enums.MachineStatus;
import lombok.*;

import java.time.OffsetDateTime;

@Entity
@Table(name = "machines")
@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class MachineEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "company_serial", unique = true)
    private String companySerial;

    @Column(name = "company_number", unique = true)
    private String companyNumber;

    private String model;
    private String brand;
    private Integer year;

    @Column(name = "current_location_id")
    private Long currentLocationId;

    @Enumerated(EnumType.STRING) // üîπ Aqu√≠ hacemos el mapping correcto
    @Column(columnDefinition = "status", nullable = false)
    private MachineStatus status;

    @Column(name = "current_customer_id")
    private Long currentCustomerId;

    private OffsetDateTime purchaseDate;
    private OffsetDateTime createdAt;
    private String notes;
}


// 

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\entity\MachineMovementEntity.java =====
package co.edu.sena.tu_unidad.entity;

import jakarta.persistence.*;
import co.edu.sena.tu_unidad.domain.enums.MovementType;
import lombok.*;

import java.time.OffsetDateTime;

@Entity
@Table(name = "machine_movements")
@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class MachineMovementEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private Long machineId;
    private Long fromLocationId;
    private Long toLocationId;
    @Enumerated(EnumType.STRING) // ‚úÖ Guardar enum como texto en la BD
    private MovementType movementType;
    private OffsetDateTime effectiveDate;
    private String reason;
    private Long relatedContractId;
    private Long createdByUserId;
    private OffsetDateTime createdAt;
}


// 

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\entity\MeterReadingEntity.java =====
package co.edu.sena.tu_unidad.entity;

import jakarta.persistence.*;
import lombok.*;

import java.time.OffsetDateTime;

@Entity
@Table(name = "meter_readings")
@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class MeterReadingEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private Long machineId;
    private Long reading;
    private OffsetDateTime readingDate;
    private Long technicianId;
    private String notes;
    @OneToOne(mappedBy = "meterReading")
    @Transient // ‚úÖ Evitar serializaci√≥n circular
    private ServiceVisitEntity serviceVisit;
    @Column(name = "color_reading")
    private Long colorReading;

    @Column(name = "scanner_reading")
    private Long scannerReading;
}


// 

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\entity\PartEntity.java =====
package co.edu.sena.tu_unidad.entity;

import jakarta.persistence.*;
import lombok.*;

import java.time.OffsetDateTime;

@Entity
@Table(name = "parts")
@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class PartEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String sku;
    private String brand;
    private String modelCompatibility;
    private String name;
    private String partType;
    private Integer stock;
    private java.math.BigDecimal unitPrice;
    private String notes;
    private OffsetDateTime createdAt;
}


// 

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\entity\ReadingTonerEntity.java =====
package co.edu.sena.tu_unidad.entity;
import jakarta.persistence.*;
import lombok.*;
import java.time.OffsetDateTime;
import jakarta.persistence.*;
import lombok.*;
import java.time.OffsetDateTime;
@Entity
@Table(name = "reading_toner")
@Data  // ‚Üê Esto genera getters y setters autom√°ticamente
@Builder
@AllArgsConstructor
@NoArgsConstructor

public class ReadingTonerEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "machine_id", nullable = false)
    private Long machineId;

    @Column(name = "technician_id")
    private Long technicianId;

    @Column(name = "reading_date", nullable = false)
    private OffsetDateTime readingDate;

    private String notes;

    @Column(name = "level_k")
    private Integer levelK;  // Black (0-100%)

    @Column(name = "level_c")
    private Integer levelC;  // Cyan (0-100%)

    @Column(name = "level_m")
    private Integer levelM;  // Magenta (0-100%)

    @Column(name = "level_y")
    private Integer levelY;  // Yellow (0-100%)

    @Column(name = "created_at")
    private OffsetDateTime createdAt;

    @PrePersist
    public void prePersist() {
        if (this.readingDate == null) {
            this.readingDate = OffsetDateTime.now();
        }
        if (this.createdAt == null) {
            this.createdAt = OffsetDateTime.now();
        }
    }
}


===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\entity\RootCauseEntity.java =====
package co.edu.sena.tu_unidad.entity;
import jakarta.persistence.*;
import lombok.*;
import java.time.OffsetDateTime;

@Entity
@Table(name = "root_causes")
@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor

public class RootCauseEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(nullable = false)
    private String name;

    private String category;

    @Column(name = "created_at")
    private OffsetDateTime createdAt;

    @PrePersist
    public void prePersist() {
        if (this.createdAt == null) {
            this.createdAt = OffsetDateTime.now();
        }
    }


}


===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\entity\ServiceRequestEntity.java =====
package co.edu.sena.tu_unidad.entity;

import jakarta.persistence.*;
import lombok.*;
import co.edu.sena.tu_unidad.domain.enums.CommChannel;
import co.edu.sena.tu_unidad.domain.enums.ServiceType;

import java.time.OffsetDateTime;

@Entity
@Table(name = "service_requests")
@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class ServiceRequestEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(unique = true)
    private String requestNumber;

    private Long customerId;
    private Long machineId;
    private String companySerial;
    private String companyNumber;
    private Long createdByUserId;
    private OffsetDateTime reportedAt;

    @Enumerated(EnumType.STRING)
    @Column(name = "reported_channel")
    private CommChannel reportedChannel;


    @Enumerated(EnumType.STRING)
    @Column(name = "service_type")
    private ServiceType serviceType;

    @Column(columnDefinition = "text")
    private String description;
    private String rootCause;
    private String status;
    private Boolean isRepeated;
    private Long repeatedOfRequestId;
    private Long assignedTechnicianId;
    private OffsetDateTime assignedAt;
    private OffsetDateTime closedAt;

    @Column(columnDefinition = "text")
    private String resolution;
    private OffsetDateTime createdAt;

    // üëâ contador est√°tico para requestNumber
    //private static long requestCounter = 2000;

    /*@PrePersist
    public void prePersist() {
        if (this.assignedAt == null) {
            this.assignedAt = OffsetDateTime.now();
        }
        if (this.createdAt == null) {
            this.createdAt = OffsetDateTime.now();
        }
        if (this.reportedAt == null) {
            this.reportedAt = OffsetDateTime.now();
        }
        if (this.status == null) {
            this.status = "ABIERTA";
        }
        if (this.requestNumber == null) {
            this.requestNumber = String.valueOf(requestCounter++);
        }
    }*/
    @Column(name = "root_cause_id")
    private Long rootCauseId;
}


// 

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\entity\ServiceVisitEntity.java =====
package co.edu.sena.tu_unidad.entity;

import jakarta.persistence.*;
import lombok.*;
import java.util.Map;

import java.time.OffsetDateTime;
import org.hibernate.annotations.JdbcTypeCode;
import org.hibernate.type.SqlTypes;

@Entity
@Table(name = "service_visits")
@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class ServiceVisitEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private Long serviceRequestId;
    private OffsetDateTime visitDatetime;
    private Long technicianId;
    private String visitNotes;


    @JdbcTypeCode(SqlTypes.JSON)  // üëà as√≠ Hibernate sabe que es jsonb
    @Column(columnDefinition = "jsonb")
    private Map<String, Object> partsUsed; // store JSON string

    private Long meterReadingBefore;
    private Long meterReadingAfter;
    private Boolean solved;
    private OffsetDateTime createdAt;
    @OneToOne
    @JoinColumn(name = "meter_reading_id")
    private MeterReadingEntity meterReading;

    @Column(name = "updated_at")
    private OffsetDateTime updatedAt;

    public OffsetDateTime getUpdatedAt() {
        return updatedAt;
    }

    public void setUpdatedAt(OffsetDateTime updatedAt) {
        this.updatedAt = updatedAt;
    }

    // NUEVO: Campo para lectura de toner
    @Column(name = "toner_reading_id")
    private Long tonerReadingId;

    // NUEVO: Campo para causa ra√≠z espec√≠fica de la visita
    @Column(name = "root_cause_id")
    private Long rootCauseId;

    // Relaci√≥n opcional con ReadingTonerEntity
    @OneToOne
    @JoinColumn(name = "toner_reading_id", insertable = false, updatable = false)
    private ReadingTonerEntity tonerReading;

    // NUEVO: Relaci√≥n con RootCauseEntity
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "root_cause_id", insertable = false, updatable = false)
    private RootCauseEntity rootCause;



    @Column(name = "start_time")
    private OffsetDateTime startTime;

    @Column(name = "end_time")
    private OffsetDateTime endTime;

    // Callbacks para actualizar timestamps
    @PreUpdate
    public void preUpdate() {
        this.updatedAt = OffsetDateTime.now();
    }

    @PrePersist
    public void prePersist() {
        if (this.createdAt == null) {
            this.createdAt = OffsetDateTime.now();
        }
        if (this.updatedAt == null) {
            this.updatedAt = OffsetDateTime.now();
        }
    }

    // M√©todo auxiliar para establecer la relaci√≥n con tonerReading
    public void assignTonerReading(ReadingTonerEntity tonerReading) {
        this.tonerReading = tonerReading;
        this.tonerReadingId = tonerReading != null ? tonerReading.getId() : null;
    }

    // NUEVO: M√©todo auxiliar para establecer la relaci√≥n con rootCause
    public void assignRootCause(RootCauseEntity rootCause) {
        this.rootCause = rootCause;
        this.rootCauseId = rootCause != null ? rootCause.getId() : null;
    }


}


// 

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\entity\TechnicianEntity.java =====
package co.edu.sena.tu_unidad.entity;

import jakarta.persistence.*;
import lombok.*;
import java.time.OffsetDateTime;

import java.time.LocalDate;

@Entity
@Table(name = "technicians")
@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class TechnicianEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String identification;
    private String fullName;
    private String phone;
    private String email;
    private String address;
    private LocalDate hireDate;
    private Boolean active;
    private String certifications;
    private OffsetDateTime createdAt;
}


// 

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\entity\UserEntity.java =====
package co.edu.sena.tu_unidad.entity;

import jakarta.persistence.*;
import lombok.*;

import java.time.OffsetDateTime;

@Entity
@Table(name = "users")
@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class UserEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(unique = true, nullable = false)
    private String username;

    @Column(name = "password_hash", nullable = false)
    private String password;

    private String fullName;
    private String role;
    private String phone;
    private String email;
    private String identification;

    private OffsetDateTime createdAt;
    private OffsetDateTime lastLoginAt;
}


// 

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\entity\VisitPartEntity.java =====
package co.edu.sena.tu_unidad.entity;

import jakarta.persistence.*;
import lombok.*;
import java.math.BigDecimal;
import java.time.OffsetDateTime;

@Entity
@Table(name = "visit_parts")
@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class VisitPartEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "service_visit_id", nullable = false)
    private ServiceVisitEntity serviceVisit;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "part_id", nullable = false)
    private PartEntity part;

    @Column(nullable = false)
    private Integer qty;

    private String serialNumber;

    private BigDecimal cost;

    @Column(name = "created_at", insertable = false, updatable = false)
    private OffsetDateTime createdAt;
}


===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\repository\CustomerRepository.java =====
package co.edu.sena.tu_unidad.repository;

import co.edu.sena.tu_unidad.entity.CustomerEntity;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;
import java.util.Optional;
@Repository
public interface CustomerRepository extends JpaRepository<CustomerEntity, Long> {

   }


// 

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\repository\LocationRepository.java =====
package co.edu.sena.tu_unidad.repository;

import co.edu.sena.tu_unidad.entity.LocationEntity;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.Optional;

public interface LocationRepository extends JpaRepository<LocationEntity, Long> {
    Optional<LocationEntity> findByCode(String code);
}


// 

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\repository\MachineMovementRepository.java =====
package co.edu.sena.tu_unidad.repository;

import co.edu.sena.tu_unidad.entity.MachineMovementEntity;
import java.util.List;
import java.util.Optional;
import org.springframework.data.jpa.repository.JpaRepository;

public interface MachineMovementRepository extends JpaRepository<MachineMovementEntity, Long> {
    List<MachineMovementEntity> findByMachineIdOrderByEffectiveDateDesc(Long machineId);
}


===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\repository\MachineRepository.java =====
package co.edu.sena.tu_unidad.repository;

import co.edu.sena.tu_unidad.entity.MachineEntity;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.List;
import java.util.Optional;

public interface MachineRepository extends JpaRepository<MachineEntity, Long> {
    Optional<MachineEntity> findByCompanySerial(String companySerial);
    Optional<MachineEntity> findByCompanyNumber(String companyNumber);
    List<MachineEntity> findByModel(String model);
}


// 

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\repository\MeterReadingRepository.java =====
package co.edu.sena.tu_unidad.repository;

import co.edu.sena.tu_unidad.entity.MeterReadingEntity;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.List;

public interface MeterReadingRepository extends JpaRepository<MeterReadingEntity, Long> {
    List<MeterReadingEntity> findByMachineIdOrderByReadingDateDesc(Long machineId);
}


// 

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\repository\PartRepository.java =====
package co.edu.sena.tu_unidad.repository;

import co.edu.sena.tu_unidad.entity.PartEntity;
import org.springframework.data.jpa.repository.JpaRepository;

public interface PartRepository extends JpaRepository<PartEntity, Long> {
    PartEntity findBySku(String sku);
}


// 

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\repository\ReadingTonerRepository.java =====
package co.edu.sena.tu_unidad.repository;

import co.edu.sena.tu_unidad.entity.ReadingTonerEntity;
import org.springframework.data.jpa.repository.JpaRepository;
import java.util.List;

public interface ReadingTonerRepository extends JpaRepository<ReadingTonerEntity, Long> {
    List<ReadingTonerEntity> findByMachineIdOrderByReadingDateDesc(Long machineId);
    List<ReadingTonerEntity> findByTechnicianId(Long technicianId);
}


===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\repository\RootCauseRepository.java =====
package co.edu.sena.tu_unidad.repository;
import co.edu.sena.tu_unidad.entity.RootCauseEntity;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;
import org.springframework.data.jpa.repository.Query;
import java.util.List;
@Repository
public interface RootCauseRepository extends JpaRepository<RootCauseEntity, Long> {
    List<RootCauseEntity> findAllByOrderByCategoryAsc();
    List<RootCauseEntity> findByCategoryOrderByNameAsc(String category);
    @Query("SELECT DISTINCT r.category FROM RootCauseEntity r ORDER BY r.category ASC")
    List<String> findDistinctCategory();
}


===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\repository\ServiceRequestRepository.java =====
package co.edu.sena.tu_unidad.repository;

import co.edu.sena.tu_unidad.entity.ServiceRequestEntity;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;
import java.time.OffsetDateTime;
import java.util.List;

@Repository
public interface ServiceRequestRepository extends JpaRepository<ServiceRequestEntity, Long> {
    List<ServiceRequestEntity> findByMachineId(Long machineId);
    List<ServiceRequestEntity> findByCustomerId(Long customerId);
    List<ServiceRequestEntity> findByReportedAtBetween(OffsetDateTime start, OffsetDateTime end);
    ServiceRequestEntity findTopByMachineIdAndRootCauseAndReportedAtAfterOrderByReportedAtAsc(Long machineId, String rootCause, OffsetDateTime after);

}


// 

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\repository\ServiceVisitRepository.java =====
package co.edu.sena.tu_unidad.repository;

import co.edu.sena.tu_unidad.entity.ServiceVisitEntity;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.List;

public interface ServiceVisitRepository extends JpaRepository<ServiceVisitEntity, Long> {
    List<ServiceVisitEntity> findByServiceRequestId(Long serviceRequestId);
    List<ServiceVisitEntity> findByTechnicianId(Long technicianId);

}


// 

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\repository\TechnicianRepository.java =====
package co.edu.sena.tu_unidad.repository;

import co.edu.sena.tu_unidad.entity.TechnicianEntity;
import org.springframework.data.jpa.repository.JpaRepository;

public interface TechnicianRepository extends JpaRepository<TechnicianEntity, Long> {
}


// 

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\repository\UserRepository.java =====
package co.edu.sena.tu_unidad.repository;

import co.edu.sena.tu_unidad.entity.UserEntity;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.Optional;

public interface UserRepository extends JpaRepository<UserEntity, Long> {
    Optional<UserEntity> findByUsername(String username);
    boolean existsByUsername(String username);
    Optional<UserEntity> findByEmail(String email);
}


// 

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\repository\VisitPartRepository.java =====
package co.edu.sena.tu_unidad.repository;

import co.edu.sena.tu_unidad.entity.VisitPartEntity;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.List;

public interface VisitPartRepository extends JpaRepository<VisitPartEntity, Long> {
    List<VisitPartEntity> findByServiceVisitId(Long serviceVisitId);
}


===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\service\AuthService.java =====
package co.edu.sena.tu_unidad.service;

import co.edu.sena.tu_unidad.dto.LoginRequestDto;
import co.edu.sena.tu_unidad.dto.LoginResponseDto;

public interface AuthService {
    LoginResponseDto login(LoginRequestDto request) throws Exception;
}


// 

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\service\CustomerService.java =====
package co.edu.sena.tu_unidad.service;

import co.edu.sena.tu_unidad.dto.CustomerDto;
import java.util.List;

public interface CustomerService {
    List<CustomerDto> getAllCustomers();
    CustomerDto getCustomerById(Long id);
    CustomerDto createCustomer(CustomerDto dto);
    CustomerDto updateCustomer(Long id, CustomerDto dto);
    boolean deleteCustomer(Long id);

}


===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\service\MachineService.java =====
package co.edu.sena.tu_unidad.service;

import co.edu.sena.tu_unidad.dto.MachineDto;

import java.util.List;

public interface MachineService {
    List<MachineDto> getAllMachines();
    MachineDto getMachineById(Long id);
    MachineDto createMachine(MachineDto dto);
    MachineDto updateMachine(Long id, MachineDto dto);
    void deleteMachine(Long id);
    List<MachineDto> searchByModel(String model);
    MachineDto findByCompanySerial(String serial);
}


// 

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\service\ReadingTonerService.java =====
package co.edu.sena.tu_unidad.service;
import co.edu.sena.tu_unidad.dto.ReadingTonerDto;
import java.util.List;

public interface ReadingTonerService {

    List<ReadingTonerDto> getReadingsByMachine(Long machineId);
    ReadingTonerDto createReadingToner(ReadingTonerDto dto);
    ReadingTonerDto updateReadingToner(Long id, ReadingTonerDto dto);
    void deleteReadingToner(Long id);
    ReadingTonerDto getReadingTonerById(Long id);
}


===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\service\RootCauseService.java =====
package co.edu.sena.tu_unidad.service;

import co.edu.sena.tu_unidad.dto.RootCauseDto;
import java.util.List;
import java.util.Map;

public interface RootCauseService {

    List<RootCauseDto> getAllRootCauses();
    List<String> getAllCategories();
    List<RootCauseDto> getRootCausesByCategory(String category);
    Map<String, List<RootCauseDto>> getRootCausesGroupedByCategory();
    RootCauseDto getRootCauseById(Long id);

}


===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\service\ServiceRequestService.java =====
package co.edu.sena.tu_unidad.service;

import co.edu.sena.tu_unidad.dto.ServiceRequestDto;
import co.edu.sena.tu_unidad.entity.ServiceRequestEntity;
import co.edu.sena.tu_unidad.repository.ServiceRequestRepository;
import java.time.OffsetDateTime;
import java.util.List;

public interface ServiceRequestService {
    List<ServiceRequestDto> getAllServiceRequests();
    List<ServiceRequestDto> getPendingServiceRequests();
    ServiceRequestDto getServiceRequestById(Long id);
    ServiceRequestDto createServiceRequest(ServiceRequestDto dto);
    ServiceRequestDto updateServiceRequestStatus(Long id, String status);
    List<ServiceRequestDto> getServiceRequestsByCustomer(Long customerId);
    List<ServiceRequestDto> getServiceRequestsByMachine(Long machineId);
    // agrega m√©todos √∫tiles para repetidos y reportes
    List<ServiceRequestEntity> getRequestsByCustomer(Long customerId);


}


// 

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\service\ServiceVisitService.java =====
package co.edu.sena.tu_unidad.service;

import co.edu.sena.tu_unidad.dto.ServiceVisitDto;

import java.util.List;

public interface ServiceVisitService {
    ServiceVisitDto createServiceVisit(ServiceVisitDto dto);
    List<ServiceVisitDto> getVisitsByRequest(Long requestId);
    List<ServiceVisitDto> getVisitsByTechnician(Long technicianId);
    ServiceVisitDto updateServiceVisit(Long id, ServiceVisitDto dto);
}


// 

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\service\TechnicianService.java =====
package co.edu.sena.tu_unidad.service;

import co.edu.sena.tu_unidad.dto.TechnicianDto;

import java.time.OffsetDateTime;
import java.util.List;

public interface TechnicianService {
    List<TechnicianDto> getAllTechnicians();
    TechnicianDto getTechnicianById(Long id);
    TechnicianDto createTechnician(TechnicianDto dto);
    TechnicianDto updateTechnician(Long id, TechnicianDto dto);
    Object getTechnicianPerformance(Long id, OffsetDateTime startDate, OffsetDateTime endDate);
    Object getTechniciansComparison(OffsetDateTime startDate, OffsetDateTime endDate);
    void deleteTechnician(Long id);
}


// 

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\service\UserService.java =====
package co.edu.sena.tu_unidad.service;

import co.edu.sena.tu_unidad.dto.UserDto;

import java.util.List;

public interface UserService {
    UserDto getUserById(Long id);
    UserDto getUserByEmail(String email);
    UserDto register(UserDto dto);
    UserDto updateUser(Long id, UserDto dto);
    void deleteUser(Long id);
    List<UserDto> getAllUsers();
    boolean changePassword(Long id, String oldPassword, String newPassword);
}


// 

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\service\VisitPartService.java =====
package co.edu.sena.tu_unidad.service;

import co.edu.sena.tu_unidad.dto.VisitPartDto;

import java.util.List;

public interface VisitPartService {
    VisitPartDto create(VisitPartDto dto);
    List<VisitPartDto> getByServiceVisit(Long serviceVisitId);
    void delete(Long id);
}


===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\service\impl\AuthServiceImpl.java =====
package co.edu.sena.tu_unidad.service.impl;

import co.edu.sena.tu_unidad.dto.LoginRequestDto;
import co.edu.sena.tu_unidad.dto.LoginResponseDto;
import co.edu.sena.tu_unidad.entity.UserEntity;
import co.edu.sena.tu_unidad.repository.UserRepository;
import co.edu.sena.tu_unidad.service.AuthService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;

@Service
public class AuthServiceImpl implements AuthService {

    @Autowired
    private UserRepository userRepository;
    @Autowired
    private PasswordEncoder encoder;

    @Override
    public LoginResponseDto login(LoginRequestDto request) throws Exception {
        UserEntity u = userRepository.findByUsername(request.getUsername())
                .orElseThrow(() -> new Exception("Usuario no encontrado"));
        if (!encoder.matches(request.getPassword(), u.getPassword())) {
            throw new Exception("Clave inv√°lida");
        }
        // token omitted (no JWT). If quieres token, lo a√±adimos aqu√≠.
        return LoginResponseDto.builder()
                .id(u.getId())
                .username(u.getUsername())
                .fullName(u.getFullName())
                .role(u.getRole())
                .token(null)
                .build();
    }
}


// 

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\service\impl\CustomerServiceImpl.java =====
package co.edu.sena.tu_unidad.service.impl;

import co.edu.sena.tu_unidad.dto.CustomerDto;
import co.edu.sena.tu_unidad.entity.CustomerEntity;
import co.edu.sena.tu_unidad.repository.CustomerRepository;
import co.edu.sena.tu_unidad.service.CustomerService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import co.edu.sena.tu_unidad.entity.LocationEntity;
import co.edu.sena.tu_unidad.dto.LocationDto;

import java.time.OffsetDateTime;
import java.util.List;
import java.util.stream.Collectors;

@Service
public class CustomerServiceImpl implements CustomerService {

    @Autowired
    private CustomerRepository repo;

    private CustomerDto toDto(CustomerEntity e) {
        if (e == null) return null;
        return CustomerDto.builder()
                .id(e.getId())
                .nit(e.getNit())
                .name(e.getName())
                .contactName(e.getContactName())
                .phone(e.getPhone())
                .email(e.getEmail())
                .address(e.getAddress())
                .location(toLocationDto(e.getLocation()))
                .build();
    }
    private LocationDto toLocationDto(LocationEntity l) {
        if (l == null) return null;
        return LocationDto.builder()
                .id(l.getId())
                .name(l.getName())
                .address(l.getAddress())
                .description(l.getDescription())
                .build();
    }

    @Override
    public List<CustomerDto> getAllCustomers() {
        return repo.findAll().stream().map(this::toDto).collect(Collectors.toList());
    }

    @Override
    public CustomerDto getCustomerById(Long id) {
        return repo.findById(id).map(this::toDto).orElse(null);
    }

    @Override
    public CustomerDto createCustomer(CustomerDto dto) {

        CustomerEntity e = new CustomerEntity();
        e.setNit(dto.getNit());
        e.setName(dto.getName());
        e.setContactName(dto.getContactName());
        e.setPhone(dto.getPhone());
        e.setEmail(dto.getEmail());
        e.setAddress(dto.getAddress());
        e.setCreatedAt(OffsetDateTime.now());
        // Crear la Location autom√°ticamente
        LocationEntity location = LocationEntity.builder()
                .name(dto.getName()) // mismo nombre del cliente
                .address(dto.getAddress())
                .description("Ubicaci√≥n principal de " + dto.getName())
                .build();

        e.setLocation(location);

        CustomerEntity saved = repo.save(e);
        return toDto(saved);
    }

    @Override
    public CustomerDto updateCustomer(Long id, CustomerDto dto) {
        CustomerEntity e = repo.findById(id).orElse(null);
        if (e == null) return null;
        e.setNit(dto.getNit());
        e.setName(dto.getName());
        e.setContactName(dto.getContactName());
        e.setPhone(dto.getPhone());
        e.setEmail(dto.getEmail());
        e.setAddress(dto.getAddress());
        repo.save(e);
        return toDto(e);
    }

    @Autowired
    private CustomerRepository repository;

    @Override
    public boolean deleteCustomer(Long id) {
        if (!repository.existsById(id)) return false;
        repository.deleteById(id);
        return true;
    }



}


===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\service\impl\MachineServiceImpl.java =====
package co.edu.sena.tu_unidad.service.impl;

import co.edu.sena.tu_unidad.dto.MachineDto;
import co.edu.sena.tu_unidad.entity.MachineEntity;
import co.edu.sena.tu_unidad.repository.MachineRepository;
import co.edu.sena.tu_unidad.repository.LocationRepository;
import co.edu.sena.tu_unidad.repository.MeterReadingRepository;
import co.edu.sena.tu_unidad.entity.MeterReadingEntity;
import co.edu.sena.tu_unidad.service.MachineService;
import co.edu.sena.tu_unidad.repository.MachineMovementRepository;
import co.edu.sena.tu_unidad.entity.MachineMovementEntity;
import co.edu.sena.tu_unidad.domain.enums.MovementType;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.time.OffsetDateTime;
import java.util.List;
import java.util.stream.Collectors;

@Service
public class MachineServiceImpl implements MachineService {

    @Autowired
    private MachineRepository machineRepository;

    @Autowired
    private LocationRepository locationRepository;

    @Autowired
    private MachineMovementRepository movementRepo;

    @Autowired
    private MeterReadingRepository meterReadingRepository;

    private MachineDto toDto(MachineEntity e) {
        if (e == null) return null;
        return MachineDto.builder()
                .id(e.getId())
                .companySerial(e.getCompanySerial())
                .companyNumber(e.getCompanyNumber())
                .model(e.getModel())
                .brand(e.getBrand())
                .year(e.getYear())
                .currentLocationId(e.getCurrentLocationId())
                .status(e.getStatus())
                .currentCustomerId(e.getCurrentCustomerId())
                .notes(e.getNotes())
                .build();
    }

    @Override
    public List<MachineDto> getAllMachines() {
        return machineRepository.findAll().stream().map(this::toDto).collect(Collectors.toList());
    }

    @Override
    public MachineDto getMachineById(Long id) {
        return machineRepository.findById(id).map(this::toDto).orElse(null);
    }

    @Override
    public MachineDto createMachine(MachineDto dto) {
        MachineEntity e = new MachineEntity();
        e.setCompanySerial(dto.getCompanySerial());
        e.setCompanyNumber(dto.getCompanyNumber());
        e.setModel(dto.getModel());
        e.setBrand(dto.getBrand());
        e.setYear(dto.getYear());
        e.setCurrentLocationId(dto.getCurrentLocationId());
        if (dto.getStatus() != null) {
            e.setStatus(dto.getStatus());
        }
        e.setCurrentCustomerId(dto.getCurrentCustomerId());
        e.setPurchaseDate(null);
        e.setCreatedAt(OffsetDateTime.now());
        e.setNotes(dto.getNotes());

        // Guardar m√°quina
        e = machineRepository.save(e);

        // ‚úÖ Crear primer movimiento con los valores correctos
        if (e.getId() != null) {
            MachineMovementEntity move = MachineMovementEntity.builder()
                    .machineId(e.getId())
                    .fromLocationId(null) // primera vez
                    .toLocationId(e.getCurrentLocationId())
                    .movementType(MovementType.INGRESO) // tu enum
                    .reason("Ubicaci√≥n inicial")
                    .createdByUserId(1L) // opcional, si tienes usuario
                    .effectiveDate(OffsetDateTime.now())
                    .createdAt(OffsetDateTime.now())
                    .build();

            movementRepo.save(move);
        }

        // ‚úÖ Si viene lectura inicial, la guardamos
        if (e.getId() != null && dto.getInitialReading() != null) {
            MeterReadingEntity mr = MeterReadingEntity.builder()
                    .machineId(e.getId())
                    .reading(dto.getInitialReading())
                    .colorReading(dto.getInitialColorReading())     // si lo quieres manejar
                    .scannerReading(dto.getInitialScannerReading()) // si lo quieres manejar
                    .readingDate(OffsetDateTime.now())
                    .notes(dto.getReadingNotes() != null ? dto.getReadingNotes() : "Lectura inicial")
                    .build();
            meterReadingRepository.save(mr);
        }

        return toDto(e);
    }

    @Override
    public MachineDto updateMachine(Long id, MachineDto dto) {
        MachineEntity e = machineRepository.findById(id).orElse(null);
        if (e == null) return null;
        e.setModel(dto.getModel());
        e.setBrand(dto.getBrand());
        e.setCompanyNumber(dto.getCompanyNumber());
        e.setCurrentLocationId(dto.getCurrentLocationId());

        e.setCurrentCustomerId(dto.getCurrentCustomerId());
        if (dto.getStatus() != null) {
            e.setStatus(dto.getStatus());  // ‚úÖ ahora enum
        }
        e.setNotes(dto.getNotes());
        machineRepository.save(e);
        return toDto(e);
    }

    @Override
    public void deleteMachine(Long id) {
        machineRepository.deleteById(id);
    }

    @Override
    public List<MachineDto> searchByModel(String model) {
        return machineRepository.findByModel(model).stream().map(this::toDto).collect(Collectors.toList());
    }

    @Override
    public MachineDto findByCompanySerial(String serial) {
        return machineRepository.findByCompanySerial(serial).map(this::toDto).orElse(null);
    }
}


// 

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\service\impl\ReadingTonerServiceImpl.java =====
package co.edu.sena.tu_unidad.service.impl;

import co.edu.sena.tu_unidad.dto.ReadingTonerDto;
import co.edu.sena.tu_unidad.entity.ReadingTonerEntity;
import co.edu.sena.tu_unidad.repository.ReadingTonerRepository;
import co.edu.sena.tu_unidad.service.ReadingTonerService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import java.time.OffsetDateTime;
import java.util.List;
import java.util.stream.Collectors;

@Service
public class ReadingTonerServiceImpl implements ReadingTonerService{
    @Autowired
    private ReadingTonerRepository repository;

    private ReadingTonerDto toDto(ReadingTonerEntity entity) {
        if (entity == null) return null;
        return ReadingTonerDto.builder()
                .id(entity.getId())
                .machineId(entity.getMachineId())
                .technicianId(entity.getTechnicianId())
                .readingDate(entity.getReadingDate())
                .notes(entity.getNotes())
                .levelK(entity.getLevelK())
                .levelC(entity.getLevelC())
                .levelM(entity.getLevelM())
                .levelY(entity.getLevelY())
                .build();
    }

    private ReadingTonerEntity toEntity(ReadingTonerDto dto) {
        if (dto == null) return null;
        return ReadingTonerEntity.builder()
                .id(dto.getId())
                .machineId(dto.getMachineId())
                .technicianId(dto.getTechnicianId())
                .readingDate(dto.getReadingDate() != null ? dto.getReadingDate() : OffsetDateTime.now())
                .notes(dto.getNotes())
                .levelK(dto.getLevelK())
                .levelC(dto.getLevelC())
                .levelM(dto.getLevelM())
                .levelY(dto.getLevelY())
                .build();
    }

    @Override
    public List<ReadingTonerDto> getReadingsByMachine(Long machineId) {
        return repository.findByMachineIdOrderByReadingDateDesc(machineId)
                .stream()
                .map(this::toDto)
                .collect(Collectors.toList());
    }

    @Override
    public ReadingTonerDto createReadingToner(ReadingTonerDto dto) {
        ReadingTonerEntity entity = toEntity(dto);
        entity = repository.save(entity);
        return toDto(entity);
    }

    @Override
    public ReadingTonerDto updateReadingToner(Long id, ReadingTonerDto dto) {
        return repository.findById(id)
                .map(existing -> {
                    if (dto.getLevelK() != null) existing.setLevelK(dto.getLevelK());
                    if (dto.getLevelC() != null) existing.setLevelC(dto.getLevelC());
                    if (dto.getLevelM() != null) existing.setLevelM(dto.getLevelM());
                    if (dto.getLevelY() != null) existing.setLevelY(dto.getLevelY());
                    if (dto.getNotes() != null) existing.setNotes(dto.getNotes());
                    if (dto.getReadingDate() != null) existing.setReadingDate(dto.getReadingDate());

                    ReadingTonerEntity saved = repository.save(existing);
                    return toDto(saved);
                })
                .orElseThrow(() -> new RuntimeException("Lectura de toner no encontrada con id: " + id));
    }

    @Override
    public void deleteReadingToner(Long id) {
        repository.deleteById(id);
    }

    @Override
    public ReadingTonerDto getReadingTonerById(Long id) {
        return repository.findById(id)
                .map(this::toDto)
                .orElse(null);
    }


}


===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\service\impl\RequestCounterInitializer.java =====
package co.edu.sena.tu_unidad.service.impl;

import co.edu.sena.tu_unidad.domain.enums.ServiceType;
import co.edu.sena.tu_unidad.repository.ServiceRequestRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.context.event.ApplicationReadyEvent;
import org.springframework.context.event.EventListener;
import co.edu.sena.tu_unidad.service.impl.RequestNumberGenerator;

import org.springframework.stereotype.Service;

import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.OffsetDateTime;
import java.time.ZoneOffset;
import java.time.format.DateTimeFormatter;
import java.util.List;

@Service
public class RequestCounterInitializer {
    @Autowired
    private ServiceRequestRepository requestRepository;

    @Autowired
    private RequestNumberGenerator numberGenerator;

    @EventListener(ApplicationReadyEvent.class)
    public void initializeCounters() {
        System.out.println("üöÄ INICIALIZANDO CONTADORES DE SOLICITUDES...");

        // Obtener la fecha de hoy
        LocalDate today = LocalDate.now();
        String todayKey = today.format(DateTimeFormatter.ofPattern("ddMMyy"));

        // Obtener todas las solicitudes del d√≠a de hoy
        // CORRECCI√ìN: Usar LocalDateTime y luego convertirlo a OffsetDateTime
        LocalDateTime startOfDayLocal = today.atStartOfDay();
        LocalDateTime endOfDayLocal = today.plusDays(1).atStartOfDay();

        // Convertir a OffsetDateTime con UTC
        OffsetDateTime startOfDay = startOfDayLocal.atOffset(ZoneOffset.UTC);
        OffsetDateTime endOfDay = endOfDayLocal.atOffset(ZoneOffset.UTC);

        List<co.edu.sena.tu_unidad.entity.ServiceRequestEntity> todayRequests =
                requestRepository.findByReportedAtBetween(startOfDay, endOfDay);

        System.out.println("Solicitudes encontradas hoy: " + todayRequests.size());

        // Inicializar contadores para cada tipo de servicio
        for (ServiceType serviceType : ServiceType.values()) {
            long countForType = todayRequests.stream()
                    .filter(r -> r.getServiceType() == serviceType)
                    .count();

            if (countForType > 0) {
                numberGenerator.initializeCounter(serviceType.name(), todayKey, (int) countForType);
                System.out.println("Contador para " + serviceType + ": " + countForType);
            }
        }

        System.out.println("‚úÖ CONTADORES INICIALIZADOS CORRECTAMENTE");
    }

}


===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\service\impl\RequestNumberGenerator.java =====
package co.edu.sena.tu_unidad.service.impl;

import co.edu.sena.tu_unidad.domain.enums.ServiceType;
import org.springframework.stereotype.Component;
import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;

@Component
public class RequestNumberGenerator {

    private final Map<String, Integer> dailyCounters = new ConcurrentHashMap<>();

    public String generateNextNumber(ServiceType serviceType) {
        LocalDate today = LocalDate.now();
        String dateKey = today.format(DateTimeFormatter.ofPattern("ddMMyy"));

        // Crear clave para el tipo de servicio en el d√≠a actual
        String counterKey = serviceType.name() + "_" + dateKey;

        // Obtener o inicializar el contador para este tipo en este d√≠a
        int currentCounter = dailyCounters.getOrDefault(counterKey, 0) + 1;
        dailyCounters.put(counterKey, currentCounter);

        // Formatear contador a 3 d√≠gitos
        String counterStr = String.format("%03d", currentCounter);

        // Obtener c√≥digo del tipo de servicio
        String typeCode = serviceType.getCodigo();

        return counterStr + typeCode + dateKey;
    }

    // M√©todo para inicializar contadores desde base de datos al iniciar
    public void initializeCounter(String serviceType, String dateKey, int lastCounter) {
        String counterKey = serviceType + "_" + dateKey;
        dailyCounters.put(counterKey, lastCounter);
    }
}


===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\service\impl\RootCauseServiceImpl.java =====
package co.edu.sena.tu_unidad.service.impl;
import co.edu.sena.tu_unidad.dto.RootCauseDto;
import co.edu.sena.tu_unidad.entity.RootCauseEntity;
import co.edu.sena.tu_unidad.repository.RootCauseRepository;
import co.edu.sena.tu_unidad.service.RootCauseService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

@Service
public class RootCauseServiceImpl implements RootCauseService {
    @Autowired
    private RootCauseRepository repository;

    private RootCauseDto toDto(RootCauseEntity entity) {
        if (entity == null) return null;
        return RootCauseDto.builder()
                .id(entity.getId())
                .name(entity.getName())
                .category(entity.getCategory())
                .build();
    }

    @Override
    public List<RootCauseDto> getAllRootCauses() {
        return repository.findAllByOrderByCategoryAsc()
                .stream()
                .map(this::toDto)
                .collect(Collectors.toList());
    }

    @Override
    public List<String> getAllCategories() {
        return repository.findDistinctCategory();
    }

    @Override
    public List<RootCauseDto> getRootCausesByCategory(String category) {
        return repository.findByCategoryOrderByNameAsc(category)
                .stream()
                .map(this::toDto)
                .collect(Collectors.toList());
    }

    @Override
    public Map<String, List<RootCauseDto>> getRootCausesGroupedByCategory() {
        List<RootCauseDto> all = getAllRootCauses();
        return all.stream()
                .collect(Collectors.groupingBy(
                        RootCauseDto::getCategory,
                        Collectors.toList()
                ));
    }

    @Override
    public RootCauseDto getRootCauseById(Long id) {
        return repository.findById(id)
                .map(this::toDto)
                .orElse(null);
    }

}


===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\service\impl\ServiceRequestServiceImpl.java =====
package co.edu.sena.tu_unidad.service.impl;

import co.edu.sena.tu_unidad.dto.ServiceRequestDto;
import co.edu.sena.tu_unidad.entity.ServiceRequestEntity;
import co.edu.sena.tu_unidad.repository.ServiceRequestRepository;
import co.edu.sena.tu_unidad.service.ServiceRequestService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import co.edu.sena.tu_unidad.service.impl.RequestNumberGenerator;

import java.time.OffsetDateTime;
import java.time.temporal.ChronoUnit;
import java.util.List;
import java.util.stream.Collectors;

@Service
public class ServiceRequestServiceImpl implements ServiceRequestService {

    @Autowired
    private ServiceRequestRepository repo;

    @Autowired
    private RequestNumberGenerator numberGenerator; // Agregar esta l√≠nea


    private ServiceRequestDto toDto(ServiceRequestEntity e) {
        if (e == null) return null;
        return ServiceRequestDto.builder()
                .id(e.getId())
                .requestNumber(e.getRequestNumber())
                .customerId(e.getCustomerId())
                .machineId(e.getMachineId())
                .companySerial(e.getCompanySerial())
                .companyNumber(e.getCompanyNumber())
                .createdByUserId(e.getCreatedByUserId())
                .reportedAt(e.getReportedAt())
                .reportedChannel(e.getReportedChannel())
                .serviceType(e.getServiceType())
                .description(e.getDescription())
                .rootCause(e.getRootCause())
                .status(e.getStatus())
                .isRepeated(e.getIsRepeated())
                .repeatedOfRequestId(e.getRepeatedOfRequestId())
                .assignedTechnicianId(e.getAssignedTechnicianId())
                .assignedAt(e.getAssignedAt())
                .closedAt(e.getClosedAt())
                .resolution(e.getResolution())
                .build();
    }

    @Override
    public List<ServiceRequestDto> getAllServiceRequests() {
        return repo.findAll().stream().map(this::toDto).collect(Collectors.toList());
    }

    @Override
    public List<ServiceRequestDto> getPendingServiceRequests() {
        return repo.findAll().stream()
                .filter(r -> r.getStatus() == null || r.getStatus().equalsIgnoreCase("abierto"))
                .map(this::toDto).collect(Collectors.toList());
    }

    @Override
    public ServiceRequestDto getServiceRequestById(Long id) {
        return repo.findById(id).map(this::toDto).orElse(null);
    }

    @Override
    public ServiceRequestDto createServiceRequest(ServiceRequestDto dto) {
        ServiceRequestEntity e = new ServiceRequestEntity();

        String requestNumber = numberGenerator.generateNextNumber(dto.getServiceType());
        e.setRequestNumber(requestNumber);

        e.setCustomerId(dto.getCustomerId());
        e.setMachineId(dto.getMachineId());
        e.setCompanySerial(dto.getCompanySerial());
        e.setCompanyNumber(dto.getCompanyNumber());
        e.setCreatedByUserId(dto.getCreatedByUserId());
        e.setReportedAt(dto.getReportedAt() != null ? dto.getReportedAt() : OffsetDateTime.now());
        e.setReportedChannel(dto.getReportedChannel());
        e.setServiceType(dto.getServiceType());
        e.setDescription(dto.getDescription());
        // CAMBIO AQU√ç: Ahora guardamos rootCauseId en lugar de rootCause (texto)
        if (dto.getRootCauseId() != null) {
            e.setRootCauseId(dto.getRootCauseId());
        } else {
            // Mantener compatibilidad con el campo anterior si es necesario
            e.setRootCause(dto.getRootCause());
        }


        e.setStatus(dto.getStatus() != null ? dto.getStatus() : "abierto");
        e.setIsRepeated(false);
        e.setCreatedAt(OffsetDateTime.now());

        // l√≥gica b√°sica para marcar repetido (ejemplo: buscar anterior en 30 d√≠as)
        /*if (e.getMachineId() != null && e.getRootCause() != null) {
            OffsetDateTime threshold = e.getReportedAt().minus(30, ChronoUnit.DAYS);
            ServiceRequestEntity prior = repo.findTopByMachineIdAndRootCauseAndReportedAtAfterOrderByReportedAtAsc(e.getMachineId(), e.getRootCause(), threshold);
            if (prior != null) {
                e.setIsRepeated(true);
                e.setRepeatedOfRequestId(prior.getId());
            }
        }*/

        if (e.getMachineId() != null && e.getRootCauseId() != null) {
            // Modificar esta l√≥gica para buscar por rootCauseId en lugar de texto
            // Tendr√≠as que crear un m√©todo en el repositorio para buscar por rootCauseId
            // Por ahora mantenemos la l√≥gica existente
            if (e.getRootCause() != null) {
                OffsetDateTime threshold = e.getReportedAt().minus(30, ChronoUnit.DAYS);
                ServiceRequestEntity prior = repo.findTopByMachineIdAndRootCauseAndReportedAtAfterOrderByReportedAtAsc(
                        e.getMachineId(), e.getRootCause(), threshold);
                if (prior != null) {
                    e.setIsRepeated(true);
                    e.setRepeatedOfRequestId(prior.getId());
                }
            }
        }

        e = repo.save(e);
        return toDto(e);
    }

    @Override
    public ServiceRequestDto updateServiceRequestStatus(Long id, String status) {
        ServiceRequestEntity e = repo.findById(id).orElse(null);
        if (e == null) return null;
        e.setStatus(status);
        if ("cerrado".equalsIgnoreCase(status) || "solved".equalsIgnoreCase(status)) {
            e.setClosedAt(OffsetDateTime.now());
        }
        repo.save(e);
        return toDto(e);
    }

    @Override
    public List<ServiceRequestDto> getServiceRequestsByCustomer(Long customerId) {
        return repo.findByCustomerId(customerId).stream().map(this::toDto).collect(Collectors.toList());
    }

    @Override
    public List<ServiceRequestDto> getServiceRequestsByMachine(Long machineId) {
        return repo.findByMachineId(machineId).stream().map(this::toDto).collect(Collectors.toList());
    }

    @Autowired
    private ServiceRequestRepository repository;

    @Override
    public List<ServiceRequestEntity> getRequestsByCustomer(Long customerId) {
        return repository.findByCustomerId(customerId);
    }

}


// 

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\service\impl\ServiceVisitServiceImpl.java =====
package co.edu.sena.tu_unidad.service.impl;

import co.edu.sena.tu_unidad.dto.ServiceVisitDto;
import co.edu.sena.tu_unidad.entity.ServiceVisitEntity;
import co.edu.sena.tu_unidad.repository.ServiceVisitRepository;
import co.edu.sena.tu_unidad.service.ServiceVisitService;
import co.edu.sena.tu_unidad.entity.MeterReadingEntity;
import co.edu.sena.tu_unidad.repository.ServiceRequestRepository;
import co.edu.sena.tu_unidad.entity.ServiceRequestEntity;
import co.edu.sena.tu_unidad.repository.MeterReadingRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import co.edu.sena.tu_unidad.entity.ReadingTonerEntity;
import co.edu.sena.tu_unidad.repository.ReadingTonerRepository;
import co.edu.sena.tu_unidad.repository.RootCauseRepository;
import co.edu.sena.tu_unidad.entity.RootCauseEntity;

import java.time.OffsetDateTime;
import java.util.List;
import java.util.stream.Collectors;

@Service
public class ServiceVisitServiceImpl implements ServiceVisitService {

    @Autowired
    private ServiceVisitRepository repo;
    @Autowired
    private ServiceRequestRepository serviceRequestRepository;
    @Autowired
    private MeterReadingRepository meterReadingRepository;
    @Autowired
    private ReadingTonerRepository readingTonerRepository;  // Nuevo

    @Autowired
    private RootCauseRepository rootCauseRepository; // NUEVO


    @Override
    public ServiceVisitDto updateServiceVisit(Long id, ServiceVisitDto dto) {
        return repo.findById(id)
                .map(existing -> {
                    existing.setTechnicianId(dto.getTechnicianId());
                    existing.setVisitNotes(dto.getVisitNotes());
                    existing.setSolved(dto.getSolved() != null ? dto.getSolved() : false);

                    if (dto.getRootCauseId() != null) {
                        RootCauseEntity rootCause = rootCauseRepository.findById(dto.getRootCauseId())
                                .orElseThrow(() -> new RuntimeException("Causa ra√≠z no encontrada con id " + dto.getRootCauseId()));
                        existing.assignRootCause(rootCause);
                    }



                    if (existing.getStartTime() == null && dto.getStartTime() != null) {
                        existing.setStartTime(dto.getStartTime());
                    }

                    if (existing.getEndTime() == null && dto.getEndTime() != null) {
                        existing.setEndTime(dto.getEndTime());
                    }

                    // Validar que endTime sea despu√©s de startTime
                    if (existing.getStartTime() != null && existing.getEndTime() != null) {
                        if (existing.getEndTime().isBefore(existing.getStartTime())) {
                            throw new RuntimeException("La hora de finalizaci√≥n debe ser posterior a la hora de inicio");
                        }
                    }


                    // Manejo de medici√≥n
                    if (Boolean.TRUE.equals(dto.getTakeMeterReading()) && dto.getReading() != null) {
                        MeterReadingEntity reading = new MeterReadingEntity();
                        reading.setReading(dto.getReading());
                        reading.setColorReading(dto.getColorReading());
                        reading.setScannerReading(dto.getScannerReading());
                        reading.setReadingDate(OffsetDateTime.now());
                        reading.setTechnicianId(dto.getTechnicianId());
                        reading.setNotes(dto.getReadingNotes());

                        // ‚úÖ buscar el request asociado y sacar el machineId
                        ServiceRequestEntity request = serviceRequestRepository
                                .findById(existing.getServiceRequestId())
                                .orElseThrow(() -> new RuntimeException("Solicitud no encontrada con id " + existing.getServiceRequestId()));

                        reading.setMachineId(request.getMachineId()); // ‚úÖ asignamos el id real de la m√°quina

                        meterReadingRepository.save(reading);
                        existing.setMeterReading(reading);
                    }

// Manejo de medici√≥n de toner (NUEVO)
                    if (Boolean.TRUE.equals(dto.getTakeTonerReading()) &&
                            (dto.getTonerLevelK() != null || dto.getTonerLevelC() != null ||
                                    dto.getTonerLevelM() != null || dto.getTonerLevelY() != null)) {

                        ReadingTonerEntity tonerReading = new ReadingTonerEntity();
                        tonerReading.setLevelK(dto.getTonerLevelK());
                        tonerReading.setLevelC(dto.getTonerLevelC());
                        tonerReading.setLevelM(dto.getTonerLevelM());
                        tonerReading.setLevelY(dto.getTonerLevelY());
                        tonerReading.setReadingDate(OffsetDateTime.now());
                        tonerReading.setTechnicianId(dto.getTechnicianId());
                        tonerReading.setNotes(dto.getTonerNotes());

                        ServiceRequestEntity request = serviceRequestRepository
                                .findById(existing.getServiceRequestId())
                                .orElseThrow(() -> new RuntimeException("Solicitud no encontrada con id " + existing.getServiceRequestId()));

                        tonerReading.setMachineId(request.getMachineId());
                        ReadingTonerEntity savedTonerReading = readingTonerRepository.save(tonerReading);
                        existing.setTonerReadingId(savedTonerReading.getId());
                    }





                    if (dto.getPartsUsed() != null) {
                        existing.setPartsUsed(dto.getPartsUsed());
                    }

                    ServiceVisitEntity saved = repo.save(existing);
                    return toDto(saved);
                })
                .orElseThrow(() -> new RuntimeException("Visita no encontrada con id " + id));
    }





    private ServiceVisitDto toDto(ServiceVisitEntity e) {
        if (e == null) return null;


        // Obtener lectura de toner si existe
        ReadingTonerEntity tonerReading = null;
        if (e.getTonerReadingId() != null) {
            tonerReading = readingTonerRepository.findById(e.getTonerReadingId()).orElse(null);
        }

        // NUEVO: Obtener informaci√≥n de causa ra√≠z si existe
        String rootCauseName = null;
        String rootCauseCategory = null;
        if (e.getRootCause() != null) {
            rootCauseName = e.getRootCause().getName();
            rootCauseCategory = e.getRootCause().getCategory();
        } else if (e.getRootCauseId() != null) {
            // Si solo tenemos el ID, buscar la entidad
            RootCauseEntity rootCause = rootCauseRepository.findById(e.getRootCauseId()).orElse(null);
            if (rootCause != null) {
                rootCauseName = rootCause.getName();
                rootCauseCategory = rootCause.getCategory();
            }
        }


        return ServiceVisitDto.builder()
                .id(e.getId())
                .serviceRequestId(e.getServiceRequestId())
                .visitDatetime(e.getVisitDatetime())
                .technicianId(e.getTechnicianId())
                .visitNotes(e.getVisitNotes())
                .solved(e.getSolved())
                .partsUsed(e.getPartsUsed()) // ahora s√≠ se devuelve el JSONB

                // si existe meterReading relacionado, mapear sus campos
                .takeMeterReading(e.getMeterReading() != null)
                .reading(e.getMeterReading() != null ? e.getMeterReading().getReading() : null)
                .colorReading(e.getMeterReading() != null ? e.getMeterReading().getColorReading() : null)

                // ‚úî Lectura Scanner
                .scannerReading(e.getMeterReading() != null ? e.getMeterReading().getScannerReading() : null)
                .readingNotes(e.getMeterReading() != null ? e.getMeterReading().getNotes() : null)



                // Mediciones de toner (NUEVO)
                .takeTonerReading(tonerReading != null)
                .tonerLevelK(tonerReading != null ? tonerReading.getLevelK() : null)
                .tonerLevelC(tonerReading != null ? tonerReading.getLevelC() : null)
                .tonerLevelM(tonerReading != null ? tonerReading.getLevelM() : null)
                .tonerLevelY(tonerReading != null ? tonerReading.getLevelY() : null)
                .tonerNotes(tonerReading != null ? tonerReading.getNotes() : null)
                .tonerReadingId(e.getTonerReadingId())

                // NUEVO: Informaci√≥n de causa ra√≠z
                .rootCauseId(e.getRootCauseId())
                .rootCauseName(rootCauseName)
                .rootCauseCategory(rootCauseCategory)

                .startTime(e.getStartTime())
                .endTime(e.getEndTime())


                .build();
    }

    @Override
    public ServiceVisitDto createServiceVisit(ServiceVisitDto dto) {
        ServiceVisitEntity e = new ServiceVisitEntity();
        e.setServiceRequestId(dto.getServiceRequestId());
        e.setVisitDatetime(dto.getVisitDatetime() != null ? dto.getVisitDatetime() : OffsetDateTime.now());
        e.setTechnicianId(dto.getTechnicianId());
        e.setVisitNotes(dto.getVisitNotes());
        e.setMeterReadingBefore(dto.getMeterReadingBefore());
        e.setMeterReadingAfter(dto.getMeterReadingAfter());
        e.setSolved(dto.getSolved() != null ? dto.getSolved() : false);
        e.setCreatedAt(OffsetDateTime.now());

        // NUEVO: Asignar causa ra√≠z si se proporciona
        if (dto.getRootCauseId() != null) {
            RootCauseEntity rootCause = rootCauseRepository.findById(dto.getRootCauseId())
                    .orElseThrow(() -> new RuntimeException("Causa ra√≠z no encontrada con id " + dto.getRootCauseId()));
            e.assignRootCause(rootCause);
        }



        // partsUsed serialized to JSON if dto.partsUsed != null -> left as null for now
        if (dto.getPartsUsed() != null) {
            e.setPartsUsed(dto.getPartsUsed());
        } else {
            e.setPartsUsed(null); // üëà expl√≠cito para que no intente castear
        }
        e = repo.save(e);
        return toDto(e);
    }

    @Override
    public List<ServiceVisitDto> getVisitsByRequest(Long requestId) {
        return repo.findByServiceRequestId(requestId).stream().map(this::toDto).collect(Collectors.toList());
    }

    @Override
    public List<ServiceVisitDto> getVisitsByTechnician(Long technicianId) {
        return repo.findByTechnicianId(technicianId).stream().map(this::toDto).collect(Collectors.toList());
    }
}


// 

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\service\impl\TechnicianServiceImpl.java =====
package co.edu.sena.tu_unidad.service.impl;

import co.edu.sena.tu_unidad.dto.TechnicianDto;
import co.edu.sena.tu_unidad.entity.TechnicianEntity;
import co.edu.sena.tu_unidad.repository.TechnicianRepository;
import co.edu.sena.tu_unidad.repository.ServiceVisitRepository;
import co.edu.sena.tu_unidad.service.TechnicianService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.time.OffsetDateTime;
import java.util.List;
import java.util.stream.Collectors;

@Service
public class TechnicianServiceImpl implements TechnicianService {

    @Autowired
    private TechnicianRepository repo;

    @Autowired
    private ServiceVisitRepository visitRepo;

    private TechnicianDto toDto(TechnicianEntity e) {
        if (e == null) return null;
        return TechnicianDto.builder()
                .id(e.getId())
                .identification(e.getIdentification())
                .fullName(e.getFullName())
                .phone(e.getPhone())
                .email(e.getEmail())
                .active(e.getActive())
                .build();
    }

    @Override
    public List<TechnicianDto> getAllTechnicians() {
        return repo.findAll().stream().map(this::toDto).collect(Collectors.toList());
    }

    @Override
    public TechnicianDto getTechnicianById(Long id) {
        return repo.findById(id).map(this::toDto).orElse(null);
    }

    @Override
    public TechnicianDto createTechnician(TechnicianDto dto) {
        TechnicianEntity e = new TechnicianEntity();
        e.setIdentification(dto.getIdentification());
        e.setFullName(dto.getFullName());
        e.setPhone(dto.getPhone());
        e.setEmail(dto.getEmail());
        e.setActive(dto.getActive() != null ? dto.getActive() : true);
        e = repo.save(e);
        return toDto(e);
    }

    @Override
    public TechnicianDto updateTechnician(Long id, TechnicianDto dto) {
        TechnicianEntity e = repo.findById(id).orElse(null);
        if (e == null) return null;
        e.setFullName(dto.getFullName());
        e.setPhone(dto.getPhone());
        e.setEmail(dto.getEmail());
        e.setActive(dto.getActive());
        repo.save(e);
        return toDto(e);
    }

    @Override
    public Object getTechnicianPerformance(Long id, OffsetDateTime startDate, OffsetDateTime endDate) {
        // Implementar l√≥gica de rendimiento: ponderado por visitas, repetidos, tiempos, etc.
        // Aqu√≠ retorno un objeto simple con conteos para que el frontend muestre.
        long totalVisits = visitRepo.findByTechnicianId(id).stream()
                .filter(v -> {
                    if (v.getVisitDatetime() == null) return false;
                    return !v.getVisitDatetime().isBefore(startDate) && !v.getVisitDatetime().isAfter(endDate);
                })
                .count();
        return java.util.Map.of("technicianId", id, "totalVisits", totalVisits);
    }

    @Override
    public Object getTechniciansComparison(OffsetDateTime startDate, OffsetDateTime endDate) {
        // Retorna un mapa simple con counts por t√©cnico (puedes enriquecer para gr√°ficos)
        List<TechnicianEntity> techs = repo.findAll();
        java.util.Map<Long, Long> map = new java.util.HashMap<>();
        for (TechnicianEntity t : techs) {
            long count = visitRepo.findByTechnicianId(t.getId()).stream()
                    .filter(v -> v.getVisitDatetime() != null && !v.getVisitDatetime().isBefore(startDate) && !v.getVisitDatetime().isAfter(endDate))
                    .count();
            map.put(t.getId(), count);
        }
        return map;
    }

    @Override
    public void deleteTechnician(Long id) {
        if (!repo.existsById(id)) {
            throw new RuntimeException("T√©cnico no encontrado con id " + id);
        }
        repo.deleteById(id);
    }
}


// 

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\service\impl\UserServiceImpl.java =====
package co.edu.sena.tu_unidad.service.impl;

import co.edu.sena.tu_unidad.dto.UserDto;
import co.edu.sena.tu_unidad.entity.UserEntity;
import co.edu.sena.tu_unidad.repository.UserRepository;
import co.edu.sena.tu_unidad.service.UserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.stream.Collectors;
import java.time.OffsetDateTime;

@Service
public class UserServiceImpl implements UserService {

    @Autowired
    private UserRepository userRepository;
    @Autowired
    private PasswordEncoder passwordEncoder;

    private UserDto toDto(UserEntity e) {
        if (e == null) return null;
        return UserDto.builder()
                .id(e.getId())
                .username(e.getUsername())
                .email(e.getEmail())
                .fullName(e.getFullName())
                .role(e.getRole())
                .phone(e.getPhone())
                .build();
    }

    @Override
    public UserDto getUserById(Long id) {
        return userRepository.findById(id).map(this::toDto).orElse(null);
    }

    @Override
    public UserDto getUserByEmail(String email) {
        return userRepository.findByEmail(email).map(this::toDto).orElse(null);
    }

    @Override
    public UserDto register(UserDto dto) {
        UserEntity e = new UserEntity();
        e.setUsername(dto.getUsername());
        e.setEmail(dto.getEmail());
        e.setFullName(dto.getFullName());
        e.setRole(dto.getRole());
        e.setPhone(dto.getPhone());
        e.setPassword(passwordEncoder.encode("default123")); // default password, change later
        e.setCreatedAt(OffsetDateTime.now());
        e = userRepository.save(e);
        return toDto(e);
    }

    @Override
    public UserDto updateUser(Long id, UserDto dto) {
        UserEntity e = userRepository.findById(id).orElse(null);
        if (e == null) return null;
        e.setFullName(dto.getFullName());
        e.setEmail(dto.getEmail());
        e.setPhone(dto.getPhone());
        e.setRole(dto.getRole());
        userRepository.save(e);
        return toDto(e);
    }

    @Override
    public void deleteUser(Long id) {
        userRepository.deleteById(id);
    }

    @Override
    public List<UserDto> getAllUsers() {
        return userRepository.findAll().stream().map(this::toDto).collect(Collectors.toList());
    }

    @Override
    public boolean changePassword(Long id, String oldPassword, String newPassword) {
        UserEntity e = userRepository.findById(id).orElse(null);
        if (e == null) return false;
        if (!passwordEncoder.matches(oldPassword, e.getPassword())) return false;
        e.setPassword(passwordEncoder.encode(newPassword));
        userRepository.save(e);
        return true;
    }
}


// 

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\back2\src\main\java\co\edu\sena\tu_unidad\service\impl\VisitPartServiceImpl.java =====
package co.edu.sena.tu_unidad.service.impl;

import co.edu.sena.tu_unidad.dto.VisitPartDto;
import co.edu.sena.tu_unidad.entity.PartEntity;
import co.edu.sena.tu_unidad.entity.ServiceVisitEntity;
import co.edu.sena.tu_unidad.entity.VisitPartEntity;
import co.edu.sena.tu_unidad.repository.PartRepository;
import co.edu.sena.tu_unidad.repository.ServiceVisitRepository;
import co.edu.sena.tu_unidad.repository.VisitPartRepository;
import co.edu.sena.tu_unidad.service.VisitPartService;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
public class VisitPartServiceImpl implements VisitPartService {

    private final VisitPartRepository visitPartRepository;
    private final ServiceVisitRepository serviceVisitRepository;
    private final PartRepository partRepository;

    @Override
    public VisitPartDto create(VisitPartDto dto) {
        ServiceVisitEntity visit = serviceVisitRepository.findById(dto.getServiceVisitId())
                .orElseThrow(() -> new RuntimeException("ServiceVisit not found"));

        PartEntity part = partRepository.findById(dto.getPartId())
                .orElseThrow(() -> new RuntimeException("Part not found"));

        VisitPartEntity entity = VisitPartEntity.builder()
                .serviceVisit(visit)
                .part(part)
                .qty(dto.getQty())
                .serialNumber(dto.getSerialNumber())
                .cost(dto.getCost())
                .build();

        VisitPartEntity saved = visitPartRepository.save(entity);

        dto.setId(saved.getId());
        return dto;
    }

    @Override
    public List<VisitPartDto> getByServiceVisit(Long serviceVisitId) {
        return visitPartRepository.findByServiceVisitId(serviceVisitId)
                .stream()
                .map(v -> VisitPartDto.builder()
                        .id(v.getId())
                        .serviceVisitId(v.getServiceVisit().getId())
                        .partId(v.getPart().getId())
                        .qty(v.getQty())
                        .serialNumber(v.getSerialNumber())
                        .cost(v.getCost())
                        .name(v.getPart().getName())   // <-- agregado
                        .sku(v.getPart().getSku())
                        .build())
                .collect(Collectors.toList());
    }

    @Override
    public void delete(Long id) {
        visitPartRepository.deleteById(id);
    }
}



